# 集群

## 介绍

使用网络将若干台计算机连通起来，并提供统一的管理方式，使其对外呈现单机的服务效果

**作用：**

1. 分散单台服务器访问压力，实现负载均衡
2. 分散单台服务器存储压力，实现可拓展
3. 降低单台服务器宕机带来的业务灾难



## 结构设计

### 数据存储设计

* 通过算法设计，计算出key应该保存的位置
* 将所有存储空间计划切割成16384份，每台主机保存一部分，每份代表一个存储空间
* 将key按照计算出的结果发到对应的存储空间

**增强可扩展性**

增加或者减少集群中的服务器个数，就将其他服务器中均分增加或减少槽的个数

### 内部通讯设计

* 各个数据库中互相通讯，保存各个库中槽的编号数据
* 外部进行请求，如果一次命中，直接返回
* 一次未命中，会根据相应的key的槽数和数据库，告知请求，然后请求在对这个数据库进行请求

这样就保证了最多两次命中

## cluster集群结构搭建

### 配置文件

* 设置加入cluster，成为其中节点

  ```
  cluster-enabled yes|no
  ```

* cluster配置文件名，该文件属于自动生成，仅用于快速查找文件并查询文件内容

  ```
  cluster-config-file <filename>
  ```

* 节点服务器相应超时时间，用于判定该节点是否下线或切换为从节点

  ```
  cluster-node-timeout <millisecond>
  ```

* master连接的最小slave数量

  ```
  cluster-migration-barrier <count>
  ```

### Cluster节点操作命令

* 查看集群节点信息

  ```
  cluster nodes
  ```

* 进入一个从节点redis，切换其主节点

  ```
  cluster replicate <master-id>
  ```

* 发现新节点，新增主节点

  ```
  cluster meet ip:port
  ```

* 忽略一个没有solt的节点

  ```
  cluster forget <id>
  ```

* 手动故障转移

  ```
  cluster failover
  ```

  